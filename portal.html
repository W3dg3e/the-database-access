<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>THE_DATABASE_ACCESS</title>

<style>
body {
  background: black;
  color: #00ff66;
  font-family: monospace;
  padding: 12px;
}

input, button {
  background: black;
  color: #00ff66;
  border: 1px solid #00ff66;
  margin: 4px 0;
  font-family: monospace;
}

.hidden { display: none; }
button { cursor: pointer; }

#error {
  color: #00aaff;
  margin-top: 6px;
}
</style>
</head>

<body>

<div id="error"></div>

<div id="loggedOut">
  <button onclick="showSignUp()">SIGN_IN</button>
  <button onclick="showLogin()">LOG_IN</button>

  <div id="signUpBox" class="hidden">
    username:<br><input id="su_user"><br>
    password:<br><input id="su_pass" type="password"><br>
    <button onclick="signUp()">CREATE_ACCOUNT</button>
  </div>

  <div id="loginBox" class="hidden">
    username:<br><input id="li_user"><br>
    password:<br><input id="li_pass" type="password"><br>
    <button onclick="logIn()">LOG_IN</button>
  </div>

  <div id="codeBox" class="hidden">
    verification.code:<br><input id="loginCode"><br>
    <button onclick="confirmLoginCode()">CONFIRM</button>
  </div>
</div>

<div id="loggedIn" class="hidden">
  <div id="statusText"></div>
  <div id="displayText"></div>
  <div id="verifyText"></div><br>

  <button onclick="logout()">LOG_OUT</button>
  <button onclick="changeDisplay()">CHANGE_DISPLAY_NAME</button>
  <button onclick="verify()">VERIFY</button>

  <div id="verifyBox" class="hidden">
    email:<br><input id="email"><br>
    code:<br><input id="verifyCode"><br>
    <button onclick="sendVerify()">SEND_CODE</button>
    <button onclick="confirmVerify()">CONFIRM</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyM3hpHWugB-9b-nlXz4HO6ORR_D3j6k2Ge5Hixfwmn7HS1GCIMh78camNX7-nGxwdGOw/exec";
let pendingLoginUser = null;

function setError(msg) {
  document.getElementById("error").textContent = msg;
}

/* STORAGE */
function users() {
  return JSON.parse(localStorage.getItem("users") || "{}");
}
function saveUsers(u) {
  localStorage.setItem("users", JSON.stringify(u));
}

/* UI */
function showSignUp() {
  setError("");
  signUpBox.classList.remove("hidden");
  loginBox.classList.add("hidden");
}
function showLogin() {
  setError("");
  loginBox.classList.remove("hidden");
  signUpBox.classList.add("hidden");
}

/* SIGN UP */
function signUp() {
  const u = su_user.value.trim();
  const p = su_pass.value;

  if (!u || !p) return setError("missing.username.or.password");

  const all = users();
  if (all[u]) return setError("account.with.that.name.already.exists");

  all[u] = {
    pass: p,
    display: u,
    verified: false,
    email: ""
  };

  saveUsers(all);
  localStorage.setItem("currentUser", u);
  showState();
}

/* LOGIN */
function logIn() {
  const u = li_user.value.trim();
  const p = li_pass.value;
  const all = users();

  if (!all[u]) return setError("account.not.found");
  if (all[u].pass !== p) return setError("wrong.password");

  setError("");

  if (all[u].verified) {
    pendingLoginUser = u;
    codeBox.classList.remove("hidden");

    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ action:"login", email: all[u].email })
    }).catch(()=>setError("email.send.failed"));
  } else {
    localStorage.setItem("currentUser", u);
    showState();
  }
}

function confirmLoginCode() {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action:"check", code: loginCode.value })
  })
  .then(r=>r.text())
  .then(t=>{
    if (t !== "OK") return setError("wrong.code");
    localStorage.setItem("currentUser", pendingLoginUser);
    pendingLoginUser = null;
    showState();
  })
  .catch(()=>setError("verification.failed"));
}

/* LOGGED IN */
function logout() {
  localStorage.removeItem("currentUser");
  showState();
}

function changeDisplay() {
  const name = prompt("display.name:");
  if (!name) return;

  const u = localStorage.getItem("currentUser");
  const all = users();
  all[u].display = name;
  saveUsers(all);
  showState();
}

/* VERIFY */
function verify() {
  verifyBox.classList.remove("hidden");
}

function sendVerify() {
  if (!email.value) return setError("email.required");

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action:"verify", email: email.value })
  })
  .then(()=>setError("verification.code.sent.if.email.is.valid"))
  .catch(()=>setError("email.send.failed"));
}

function confirmVerify() {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action:"check", code: verifyCode.value })
  })
  .then(r=>r.text())
  .then(t=>{
    if (t !== "OK") return setError("wrong.code");

    const u = localStorage.getItem("currentUser");
    const all = users();
    all[u].verified = true;
    all[u].email = email.value;
    saveUsers(all);
    showState();
  });
}

/* STATE */
function showState() {
  setError("");
  const u = localStorage.getItem("currentUser");

  if (!u) {
    loggedOut.classList.remove("hidden");
    loggedIn.classList.add("hidden");
    return;
  }

  const d = users()[u];
  loggedOut.classList.add("hidden");
  loggedIn.classList.remove("hidden");

  statusText.textContent = "logged.in.as." + u;
  displayText.textContent = "display.name.set.to." + d.display;
  verifyText.textContent = d.verified ? "verified.as." + d.email : "";
}

showState();
</script>

</body>
</html>
