<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>THE_DATABASE_ACCESS</title>

<style>
body {
  background:black;
  color:#00ff66;
  font-family:monospace;
  padding:12px;
}

input, button {
  background:black;
  color:#00ff66;
  border:1px solid #00ff66;
  margin:4px 0;
  font-family:monospace;
}

#error { color:#00aaff; min-height:1em; }
.hidden { display:none; }

.trophy {
  width:24px;
  height:24px;
  vertical-align:middle;
}
</style>
</head>

<body>

<div id="error"></div>

<div id="loggedOut">
  username:<br>
  <input id="u"><br>
  password:<br>
  <input id="p" type="password"><br>
  <button onclick="signup()">SIGN_IN</button>
  <button onclick="login()">LOG_IN</button>
</div>

<div id="twoSA" class="hidden">
  two.step.code:<br>
  <input id="loginCode"><br>
  <button onclick="confirm2SA()">CONFIRM</button>
</div>

<div id="loggedIn" class="hidden">
  logged.in.as.<span id="userText"></span>
  <span id="trophyBox"></span><br>

  <div id="displayText"></div>
  <div id="verifyText"></div>

  new.display.name:<br>
  <input id="newDisplay"><br>
  <button onclick="setDisplay()">SET_DISPLAY</button><br>

  email.for.verification:<br>
  <input id="email"><br>
  <button onclick="sendCode()">SEND_CODE</button><br>

  verification.code:<br>
  <input id="code"><br>
  <button onclick="verify()">VERIFY</button><br>

  <button onclick="logout()">LOG_OUT</button>
</div>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbwT2FnZA1rfA20xstYhAynWe0Hoj_d5CvUMvW3-U9Gd2JcE6pdycxyrIQ_JJeRjoLEtAQ/exec";

/* ---------- STORAGE ---------- */

function users() {
  return JSON.parse(localStorage.getItem("users") || "{}");
}
function saveUsers(u) {
  localStorage.setItem("users", JSON.stringify(u));
}
function setError(t) {
  document.getElementById("error").textContent = t;
}

/* ---------- AUTH ---------- */

function signup() {
  const u = uEl().value;
  const p = pEl().value;
  const all = users();

  if (!u || !p) return setError("missing.fields");
  if (all[u]) return setError("account.exists");

  all[u] = {
    pass: p,
    display: u,
    verified: false,
    email: "",
    code: "",
    trophies: []
  };
  saveUsers(all);
  login();
}

function login() {
  const u = uEl().value;
  const p = pEl().value;
  const all = users();

  if (!all[u]) return setError("account.not.found");
  if (all[u].pass !== p) return setError("wrong.password");

  if (all[u].verified) {
    sendLoginCode(u);
    localStorage.setItem("pending2SA", u);
    show("twoSA");
    hide("loggedOut");
    return;
  }

  localStorage.setItem("currentUser", u);
  updateUI();
}

function sendLoginCode(u) {
  const all = users();
  const code = Math.floor(100000 + Math.random()*900000).toString();

  all[u].code = code;
  saveUsers(all);

  fetch(API_URL, {
    method:"POST",
    body: JSON.stringify({ email: all[u].email, code })
  });

  setError("two.step.code.sent");
}

function confirm2SA() {
  const u = localStorage.getItem("pending2SA");
  const input = document.getElementById("loginCode").value;
  const all = users();

  if (input !== all[u].code) return setError("wrong.code");

  localStorage.removeItem("pending2SA");
  localStorage.setItem("currentUser", u);
  updateUI();
}

function logout() {
  localStorage.removeItem("currentUser");
  updateUI();
}

/* ---------- DISPLAY ---------- */

function setDisplay() {
  const u = current();
  const name = document.getElementById("newDisplay").value;
  if (!name) return setError("empty.display");

  const all = users();
  all[u].display = name;
  saveUsers(all);

  document.getElementById("displayText").textContent =
    "display.name.set.to." + name;
}

/* ---------- VERIFICATION ---------- */

function sendCode() {
  const u = current();
  const email = document.getElementById("email").value;
  if (!email) return setError("email.required");

  const code = Math.floor(100000 + Math.random()*900000).toString();
  const all = users();

  all[u].email = email;
  all[u].code = code;
  saveUsers(all);

  fetch(API_URL, {
    method:"POST",
    body: JSON.stringify({ email, code })
  });

  setError("verification.code.sent");
}

function verify() {
  const u = current();
  const input = document.getElementById("code").value;
  const all = users();

  if (input !== all[u].code) return setError("wrong.code");

  all[u].verified = true;

  if (!all[u].trophies.includes("Verified_User")) {
    all[u].trophies.push("Verified_User");
  }

  saveUsers(all);

  document.getElementById("verifyText").textContent =
    "verified.as." + all[u].email;
}

/* ---------- UI ---------- */

function updateUI() {
  const u = current();
  hide("twoSA");

  if (!u) {
    show("loggedOut");
    hide("loggedIn");
    return;
  }

  show("loggedIn");
  hide("loggedOut");

  const all = users();
  document.getElementById("userText").textContent = u;
  document.getElementById("displayText").textContent =
    "display.name." + all[u].display;

  if (all[u].verified) {
    document.getElementById("verifyText").textContent =
      "verified.as." + all[u].email;
  }

  renderTrophy(all[u]);
}

function renderTrophy(user) {
  const box = document.getElementById("trophyBox");
  box.innerHTML = "";

  user.trophies.forEach(t => {
    const img = document.createElement("img");
    img.src = "https://via.placeholder.com/24";
    img.className = "trophy";
    img.title = t;
    box.appendChild(img);
  });
}

function current() {
  return localStorage.getItem("currentUser");
}
function uEl(){ return document.getElementById("u"); }
function pEl(){ return document.getElementById("p"); }
function show(id){ document.getElementById(id).classList.remove("hidden"); }
function hide(id){ document.getElementById(id).classList.add("hidden"); }

updateUI();
</script>

</body>
</html>
