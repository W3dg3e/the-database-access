<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>THE_DATABASE_ACCESS</title>

<style>
body {
  background:black;
  color:#00ff66;
  font-family:monospace;
  padding:12px;
}

input, button {
  background:black;
  color:#00ff66;
  border:1px solid #00ff66;
  margin:4px 0;
  font-family:monospace;
}

#error { color:#00aaff; min-height:1em; }
.hidden { display:none; }

.trophy {
  width:24px;
  height:24px;
  vertical-align:middle;
}
</style>
</head>

<body>

<div id="error"></div>

<div id="loggedOut">
  username:<br>
  <input id="u"><br>
  password:<br>
  <input id="p" type="password"><br>
  <button onclick="signup()">SIGN_IN</button>
  <button onclick="login()">LOG_IN</button>
</div>

<div id="twoSA" class="hidden">
  two.step.code:<br>
  <input id="loginCodeInput"><br>
  <button onclick="confirm2SA()">CONFIRM</button>
</div>

<div id="loggedIn" class="hidden">
  loggeddae.in.as.<span id="userText"></span>
  <span id="trophyBox"></span><br>

  <div id="displayText"></div>
  <div id="verifyText"></div>

  new.display.name:<br>
  <input id="newDisplay"><br>
  <button onclick="setDisplay()">SET_DISPLAY</button><br>

  email.for.verification:<br>
  <input id="email"><br>
  <button onclick="sendVerifyCode()">SEND_CODE</button><br>

  verification.code:<br>
  <input id="verifyCodeInput"><br>
  <button onclick="verify()">VERIFY</button><br>

  <button onclick="logout()">LOG_OUT</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxdk8-dJ3ADNuhSwvmdrfxWH-Xzq-_kD6B-Ng_r-6UMPtDiejLCRIguza6CAH-tOqXuFw/exec";

const TROPHY_IMG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAM1BMVEUAAAD///////////////////////////////////////////////8fHx9cGqFZAAAAEHRSTlMAAQIDBAUGBwgJCgsMDQ4Pz2x1AAAAKElEQVQY02NgQAXGJiYmJgYGBgZGJiYmJgYGAAIMABJcAE9Xy0SAAAAAElFTkSuQmCC";

function users(){return JSON.parse(localStorage.getItem("users")||"{}");}
function saveUsers(u){localStorage.setItem("users",JSON.stringify(u));}
function current(){return localStorage.getItem("currentUser");}
function setError(t){document.getElementById("error").textContent=t||"";}

function signup(){
  setError("");
  const u=uEl().value,p=pEl().value;
  const all=users();
  if(!u||!p) return setError("missing.fields");
  if(all[u]) return setError("account.exists");

  all[u]={pass:p,display:u,verified:false,email:"",vcode:"",trophy:false};
  saveUsers(all);
  localStorage.setItem("currentUser",u);
  updateUI();
}

function login(){
  setError("");
  const u=uEl().value,p=pEl().value;
  const all=users();
  if(!all[u]) return setError("account.not.found");
  if(all[u].pass!==p) return setError("wrong.password");
if (all[u].verified) {
  const code = Math.floor(100000 + Math.random() * 900000).toString();
  all[u].loginCode = code;
  saveUsers(all);

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: all[u].email, code: code })
  });

  localStorage.setItem("pending2SA", u);
  setError("2SA.CODE.SENT");
  return;
}
  localStorage.setItem("currentUser",u);
  updateUI();
}

function logout(){
  localStorage.removeItem("currentUser");
  updateUI();
}

function setDisplay(){
  setError("");
  const u=current();
  const name=document.getElementById("newDisplay").value;
  if(!name) return setError("empty.display");

  const all=users();
  all[u].display=name;
  saveUsers(all);
  updateUI();
}

function sendCode() {
  const u = current();
  const email = document.getElementById("email").value;
  if (!email) return setError("email.required");

  const code = Math.floor(10000000 + Math.random() * 90000000).toString(); // 8-digit
  const all = users();

  all[u].email = email;
  all[u].code = code;
  saveUsers(all);

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: email, code: code })
  })
  .then(r => r.text())
  .then(t => {
    setError("verification.code.sent");
  })
  .catch(e => {
    setError("email.send.failed");
  });
}


function verify() {
  const u = current();
  const input = document.getElementById("code").value;
  const all = users();

  if (!input) return setError("code.required");
  if (input !== all[u].code) return setError("wrong.code");

  all[u].verified = true;
  saveUsers(all);

  document.getElementById("verifyText").textContent =
    "verified.as." + all[u].email;

  setError("ACCOUNT.VERIFIED");
}


function updateUI(){
  const u=current();
  const all=users();

  if(!u){
    show("loggedOut"); hide("loggedIn");
    return;
  }

  hide("loggedOut"); show("loggedIn");

  document.getElementById("userText").textContent=u;
  document.getElementById("displayText").textContent="display.name."+all[u].display;

  const vt=document.getElementById("verifyText");
  vt.innerHTML="";

  if(all[u].verified){
    vt.textContent="verified.as."+all[u].email+" ";

    if(all[u].trophy){
      const img=document.createElement("img");
      img.src=TROPHY_IMG;
      img.title="VERIFIED_ACCOUNT";
      img.style.width="16px";
      img.style.verticalAlign="middle";
      vt.appendChild(img);
    }
  }
}

function uEl(){return document.getElementById("u");}
function pEl(){return document.getElementById("p");}
function show(id){document.getElementById(id).classList.remove("hidden");}
function hide(id){document.getElementById(id).classList.add("hidden");}

updateUI();
</script>


</body>
</html>
